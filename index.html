<!DOCTYPE html>
<html lang="en">
<head>
    <title>3D_Online_Measurement_Portal</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, , initial-scale=1.0">
    <link type="text/css" rel="stylesheet" href="css/main.css">
    <style>
        body {
            color: #000;
            font-family:Monospace;
            font-size:13px;
            text-align:center;

            background-color: #fff;
            margin: 0px;
            overflow: hidden;
            height: auto;
        }

        #menu {
            position: relative;
            color:#000;
            width: 100%;
            padding: 5px;

        }

        #info {
            position: absolute;
            width: 500px;
            right: 0px;
            top: 40px;
            color:#000;
            padding: 5px;
            opacity: 0.9;
        }

        #container {
            width: 100%;
            height: 800px;
        }

        .measurement_info {
            border: 1px solid #aaa;
            padding: 5px;
            margin: 5px;
        }

        .measurement_description {
            overflow: auto;
            width: 450px;
            padding: 2px;
        }
    </style>
</head>


<body>
<div id="header">
    <!-- <h1>"HealWell - Doctor's Portal"</h1> -->
    </div>
    <div id="videoPopup" class="modal">
        <span class="close" onclick="closeVideoPopup()">&times;</span>
        <iframe src="./models/IMG_6018.mp4" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
      <div id="doctorInputPopup" class="modal">
        <div class="modal-content">
          <input type="text" id="plan" placeholder="Plan">
          <br> <!-- Add a line break to place the next input below -->
          <input type="text" id="comments" placeholder="Comments">
          <br> <!-- Add a line break to place the next input below -->
          <button class="close-button">Close</button>
        </div>
      </div>
        <div id="buttonContainer">
            <button id="VideoPreview"><span class="hidden-text">Vidoe Preview</span><img src="./assets/video.png"  alt="Symbol 1" width="32" height="32" title="Video Preview"></button>
            <button id="DoctorInput"><span class="hidden-text">Surgeon's Input</span><img src="./assets/text.png"  alt="Symbol 1" width="32" height="32" title="Surgeon's Input"></button>
            <button id="distancebutton"><span class="hidden-text">Measure Distance</span><img src="./assets/measure.png"  alt="Symbol 1" width="32" height="32" title="Measure Distance"></button>
            <!-- <button id="infobutton">Point Info</button> -->
            <button id="clearbutton"><span class="hidden-text">Clear</span><img src="./assets/clear.png"  alt="Symbol 1" width="32" height="32" title="Clear"></button>
        </div>
<div id="info"></div>
<div id="container"></div>

<div id="footer">
    <p>healwell.in</p>
  </div>

<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three@0.119.1/build/three.module.js"
				}
			}
</script>
<script src="./js/dependencies/ui.js"></script>
<script type="module">
    import * as THREE from 'three';
    import {
        PerspectiveCamera,
        WebGLRenderer,
        sRGBEncoding,
        HemisphereLight
    } from 'three';
    import {OrbitControls} from 'https://unpkg.com/three@0.119.1/examples/jsm/controls/OrbitControls.js';
    import {TrackballControls} from 'https://unpkg.com/three@0.119.1/examples/jsm/controls/TrackballControls.js';
    import {GLTFLoader} from "https://unpkg.com/three@0.119.1/examples/jsm/loaders/GLTFLoader.js"
    import {View3D} from './js/3DView/3DView.Measurements.js';
    import {MeasurementInfo} from './js/3DView/measurements/Measurement.Info.js';
    import {MeasurementDistance} from './js/3DView/measurements/Measurement.Distance.js';

    let container, stats, camera, scene, renderer, controls;
    container = document.createElement('div');
    document.body.appendChild(container);


    camera = new PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0.5, -0.5, 0.5);

    // renderer
    renderer = new WebGLRenderer({antialias: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = sRGBEncoding;
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);


    //you can use the type of controls you want TrackballControls,OrbitControls...
    const control = new OrbitControls(camera, renderer.domElement);
    control.enableDamping = true;
    control.dampingFactor = 0.25;
    control.enableZoom = true;

    var view = new View3D(document.getElementById( 'container' ), renderer, control,camera);


    const loader = new GLTFLoader();

    loader.load(
	// resource URL
	'./models/mesh.gltf',
	// called when the resource is loaded
	function ( gltf ) {

		view.scene.add( gltf.scene );
        gltf.scene.scale.set(.01*gltf.scene.scale.x, .01*gltf.scene.scale.y, .01 * gltf.scene.scale.z)
        // gltf.scene.position.y = -3

	},
	// called while loading is progressing
	function ( xhr ) {

		console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );

	},
	// called when loading has errors
	function ( error ) {

		console.log( error );

	}
    );

    //Lights
    const ambientLight = new THREE.AmbientLight( 0xffffff, 0 );
    view.scene.add( ambientLight );

    var element=document.getElementById("clearbutton");
    var listener=element.addEventListener('click',function(event){
        view.clearMeasurements();
    });

    var element=document.getElementById("distancebutton");
    var listener=element.addEventListener('click',function(event){
        view.addMeasurement(new MeasurementDistance());
    });

    //on measurement added
    view.addEventListener( 'measurementAdded', function (event) {
        var measurement = event.object;
        if (measurement) {
            var infoDiv = document.getElementById( 'info' );
            var measurementDiv = document.createElement('div');
            measurementDiv.id = 'measurement_' + measurement.id;
            measurementDiv.className = 'measurement_info';
            infoDiv.appendChild(measurementDiv);

            var descriptionDiv = document.createElement('div');
            descriptionDiv.id = 'description_' + measurement.id;
            descriptionDiv.className = 'measurement_description';
            descriptionDiv.innerHTML = measurement.getType() + " = " + (measurement.getValue() * 100).toFixed(1) + " " + JSON.stringify(measurement.getInfo());
            measurementDiv.appendChild(descriptionDiv);

            var removeButton = document.createElement('button');
            removeButton.className = 'measurement_remove';
            removeButton.innerHTML = 'Remove';
            removeButton.onclick = function() {
                view.removeMeasurement(measurement);
            }
            measurementDiv.appendChild(removeButton);
        }
    } );

    //on measurement changed
    view.addEventListener( 'measurementChanged', function (event) {
        var measurement = event.object;
        if (measurement) {
            var descriptionDiv = document.getElementById('description_' + measurement.id);
            if (descriptionDiv)
                descriptionDiv.innerHTML = measurement.getType() + " = " + (measurement.getValue() * 100).toFixed(1);
        }

    } );

    //on measurement removed
    view.addEventListener( 'measurementRemoved', function (event) {
        var measurement = event.object;
        if (measurement) {
            var measurementDiv = document.getElementById('measurement_' + measurement.id);
            measurementDiv.parentNode.removeChild(measurementDiv);
        }

    } );

    function addShadowedLight(x, y, z, color, intensity) {
        const directionalLight = new THREE.DirectionalLight(color, intensity);
        directionalLight.position.set(x, y, z);
        view.scene.add(directionalLight);
        directionalLight.castShadow = true;
        const d = 1;
        directionalLight.shadow.camera.left = -d;
        directionalLight.shadow.camera.right = d;
        directionalLight.shadow.camera.top = d;
        directionalLight.shadow.camera.bottom = -d;
        directionalLight.shadow.camera.near = 1;
        directionalLight.shadow.camera.far = 4;
        directionalLight.shadow.bias = -0.002;
    }

    function showVideoPopup() {
        document.getElementById('videoPopup').style.display = 'block';
        }

    function closeVideoPopup() {
        document.getElementById('videoPopup').style.display = 'none';
        }
    
    document.addEventListener('DOMContentLoaded', function() {
        var videoPreviewMenuItem = document.getElementById("VideoPreview");
        videoPreviewMenuItem.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default behavior of the link
            showVideoPopup(); // Call the function to show the video popup
        });
        var closeVideoButton = document.querySelector('#videoPopup .close');
        closeVideoButton.addEventListener('click', function() {
            closeVideoPopup(); // Call the function to close the video popup
        });
        });

    document.addEventListener('DOMContentLoaded', function() {
        var doctorInputMenuItem = document.getElementById("DoctorInput");
        doctorInputMenuItem.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default behavior of the link
            showDoctorInputPopup(); // Call the function to show the doctor input popup
        });

        var closeDoctorInputButton = document.querySelector('.close-button');
        closeDoctorInputButton.addEventListener('click', function() {
            closeDoctorInputPopup(); // Call the function to close the doctor input popup
        });
        });
        document.getElementById('doctorInputPopup').style.display = 'none';

    function showDoctorInputPopup() {
    document.getElementById('doctorInputPopup').style.display = 'block';
    }

    function closeDoctorInputPopup() {
    document.getElementById('doctorInputPopup').style.display = 'none';
    }

    // // Get the popup element
    // var popup = document.getElementById('doctorInputPopup');

    // // Get the popup's title bar (you can replace 'popupTitle' with the actual ID or class of the title bar)
    // var popupTitle = document.getElementById('doctorInputPopup');

    // // Initialize the position variables
    // var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    // // Function to handle mouse drag events
    // popupTitle.onmousedown = dragMouseDown;

    // // Function to handle mouse drag events
    // function dragMouseDown(e) {
    // e = e || window.event;
    // e.preventDefault();
    // // Get the mouse cursor position at startup
    // pos3 = e.clientX;
    // pos4 = e.clientY;
    // document.onmouseup = closeDragElement;
    // // Call a function whenever the cursor moves
    // document.onmousemove = elementDrag;
    // }

    // // Function to handle the dragging of the popup
    // function elementDrag(e) {
    // e = e || window.event;
    // e.preventDefault();
    // // Calculate the new cursor position
    // pos1 = pos3 - e.clientX;
    // pos2 = pos4 - e.clientY;
    // pos3 = e.clientX;
    // pos4 = e.clientY;
    // // Set the popup's new position
    // popup.style.top = (popup.offsetTop - pos2) + "px";
    // popup.style.left = (popup.offsetLeft - pos1) + "px";
    // }

    // // Function to stop the dragging when the mouse button is released
    // function closeDragElement() {
    // // Stop moving when mouse button is released
    // document.onmouseup = null;
    // document.onmousemove = null;
    // }

</script>

</body>
</html>