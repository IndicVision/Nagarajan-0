<!DOCTYPE html>
<html lang="en">
<head>
    <title>3D_Online_Measurement_Portal</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="css/main.css">
    <style>
        body {
            color: #000;
            font-family:Monospace;
            font-size:13px;
            text-align:center;

            background-color: #fff;
            margin: 0px;
            overflow: hidden;
            height: auto;
        }

        #menu {
            position: relative;
            color:#000;
            width: 100%;
            padding: 5px;

        }

        #info {
            position: absolute;
            width: 500px;
            right: 0px;
            top: 40px;
            color:#000;
            padding: 5px;
            opacity: 0.9;
        }

        #container {
            width: 100%;
            height: 800px;
        }

        .measurement_info {
            border: 1px solid #aaa;
            padding: 5px;
            margin: 5px;
        }

        .measurement_description {
            overflow: auto;
            width: 450px;
            padding: 2px;
        }
    </style>
</head>


<body>
<div id="header">
    <!-- <h1>"HealWell - Doctor's Portal"</h1> -->
    </div>
    <div id="loader">Loading...</div>
    <div id="mainContainer">
    <div id="videoPopup" class="modal">
        <span class="close" onclick="closeVideoPopup()">&times;</span>
        <iframe src="./models/IMG_6018.mp4" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
      <div id="doctorInputPopup" class="modal">
        <div class="modal-content">
          <input type="text" id="Patient's Name" placeholder="Patient's Name">
          <br> <!-- Add a line break to place the next input below -->
          <input type="text" id="Surgeon's Name" placeholder="Surgeon's Name">
          <br> <!-- Add a line break to place the next input below -->
          <select id="Time at Presentation (TIP)">
            <option value="">Select Time at Presentation (TIP)</option>
            <option value="Non-Acute">Non-Acute</option>
            <option value="Recurrent (recurrence after complete healing)">Recurrent (recurrence after complete healing)</option>
            <option value="Persistent (remains unhealed with treatment but by choice)">Persistent (remains unhealed with treatment but by choice)</option>
            <option value="Chronic (longer than 2 months)">Chronic (longer than 2 months)</option>
            <option value="Sub-acute (2 weeks - 2 months)">Sub-acute (2 weeks - 2 months)</option>
            <option value="Acute; acute on chronic (acute exacerbation in the presence of chronic ulcer)">Acute; acute on chronic (acute exacerbation in the presence of chronic ulcer)</option>
          </select>
          <br> <!-- Add a line break to place the next input below -->
          <select id="Type at Presentation (TYP)">
            <option value="">Select Type at Presentation (TYP)</option>
            <option value="Normal foot; Foot at risk">Normal foot; Foot at risk</option>
            <option value="Multiple sites (on the same foot); Bilateral">Multiple sites (on the same foot); Bilateral</option>
            <option value="Inoperable; Non-compliant; Non-affordable">Inoperable; Non-compliant; Non-affordable</option>
            <option value="Precipitating factors present; Ill-fitting shoes">Precipitating factors present; Ill-fitting shoes</option>
            <option value="Infected tendon; Osteomyelitis">Infected tendon; Osteomyelitis</option>
            <option value="Toe-threatening; Limb-threatening; Life-threatening; Necrotising fasciitis">Toe-threatening; Limb-threatening; Life-threatening; Necrotising fasciitis</option>
          </select>
          <br> <!-- Add a line break to place the next input below -->
          <select id="Status of the Skin/Ulcer (SSU)">
            <option value="">Select Status of the Skin/Ulcer (SSU)</option>
            <option value="Normal (pinkish white)">Normal (pinkish white)</option>
            <option value="Pink (epithelialising)">Pink (epithelialising)</option>
            <option value="White (fungal); White (acute on chronic); Osteomyelitis (soddening)">White (fungal); White (acute on chronic); Osteomyelitis (soddening)</option>
            <option value="Yellow (slough); Non-infected; Non-healing ulcer; Sinus">Yellow (slough); Non-infected; Non-healing ulcer; Sinus</option>
            <option value="Black (ischemic); Red granulating wound">Black (ischemic); Red granulating wound</option>
            <option value="Pus/abscess; Infected callus; Acute penetrating; Burns; Shoebite">Pus/abscess; Infected callus; Acute penetrating; Burns; Shoebite</option>
          </select>
          <br> <!-- Add a line break to place the next input below -->
          <select id="Status of the Foot (SF)">
            <option value="">Select Status of the Foot (SF)</option>
            <option value="Normal">Normal</option>
            <option value="Osteoarthropathy; Arch collapse; Corrected Score 0">Osteoarthropathy; Arch collapse; Corrected Score 0</option>
            <option value="Neuropathy; Neuropathy reversed score 0">Neuropathy; Neuropathy reversed score 0</option>
            <option value="Ischemic; Ischemic reversed score 0">Ischemic; Ischemic reversed score 0</option>
            <option value="Neuroischemic generally non-reversible">Neuroischemic generally non-reversible</option>
            <option value="Severe Charcot; Mixed status; Critical limb ischemia">Severe Charcot; Mixed status; Critical limb ischemia</option>
          </select>
          <br> <!-- Add a line break to place the next input below -->
          <select id="Status of Diabetes Mellitus (SDM)">
            <option value="">Select Status of Diabetes Mellitus (SDM)</option>
            <option value="Not known">Not known</option>
            <option value="Pre-Diabetes/IGT">Pre-Diabetes/IGT</option>
            <option value="Newly diagnosed">Newly diagnosed</option>
            <option value="Well-controlled, HbA1c < 7">Well-controlled, HbA1c < 7</option>
            <option value="Poorly controlled HbA1c > 9">Poorly controlled HbA1c > 9</option>
            <option value="Ketoacidosis; Hyponatremia">Ketoacidosis; Hyponatremia</option>
          </select>
          <br> <!-- Add a line break to place the next input below -->
          <select id="Status of the Organ System (SOS)">
            <option value="">Select Status of the Organ System (SOS)</option>
            <option value="Not affected">Not affected</option>
            <option value="HAEMOPOIETIC system; Leukocytosis; Leukopenia; Thrombocytopenia">HAEMOPOIETIC system; Leukocytosis; Leukopenia; Thrombocytopenia</option>
            <option value="HEART: Myocardial Infarction; Cardiac Myopathy">HEART: Myocardial Infarction; Cardiac Myopathy</option>
            <option value="KIDNEY: Acute kidney failure; Chrnoic kidney failure; Actue on chronic">KIDNEY: Acute kidney failure; Chrnoic kidney failure; Actue on chronic</option>
            <option value="LUNGS: Acute lung injury; ARDS; Pneumonia">LUNGS: Acute lung injury; ARDS; Pneumonia</option>
            <option value="Multiple organ systems">Multiple organ systems</option>
          </select>
          <br> <!-- Add a line break to place the next input below -->
          <input type="text" id="plan" placeholder="Plan">
          <br> <!-- Add a line break to place the next input below -->
          <input type="text" id="comments" placeholder="comments">
          <br> <!-- Add a line break to place the next input below -->
          <button id="saveButton">Save</button>
          <button class="close-button">Close</button>
        </div>
      </div>
        <div id="buttonContainer">
            <button id="VideoPreview"><span class="hidden-text">Vidoe Preview</span><img src="./assets/video.svg"  alt="Symbol 1" width="32" height="32" title="Video Preview"></button>
            <button id="DoctorInput"><span class="hidden-text">Surgeon's Input</span><img src="./assets/text.svg"  alt="Symbol 1" width="32" height="32" title="Surgeon's Input"></button>
            <button id="distancebutton"><span class="hidden-text">Measure Distance</span><img src="./assets/measure.svg"  alt="Symbol 1" width="32" height="32" title="Measure Distance"></button>
            <!-- <button id="infobutton">Point Info</button> -->
            <button id="clearbutton"><span class="hidden-text">Clear</span><img src="./assets/clear.svg"  alt="Symbol 1" width="32" height="32" title="Clear"></button>
        </div>
    <div id="info"></div>
    <div id="container"></div>
    </div>

<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three@0.119.1/build/three.module.js"
				}
			}
</script>
<script src="./js/dependencies/ui.js"></script>
<script type="module">
    import * as THREE from 'three';
    import {
        PerspectiveCamera,
        WebGLRenderer,
        sRGBEncoding,
        HemisphereLight
    } from 'three';
    import {OrbitControls} from 'https://unpkg.com/three@0.119.1/examples/jsm/controls/OrbitControls.js';
    import {TrackballControls} from 'https://unpkg.com/three@0.119.1/examples/jsm/controls/TrackballControls.js';
    import {GLTFLoader} from "https://unpkg.com/three@0.119.1/examples/jsm/loaders/GLTFLoader.js"
    import {View3D} from './js/3DView/3DView.Measurements.js';
    import {MeasurementInfo} from './js/3DView/measurements/Measurement.Info.js';
    import {MeasurementDistance} from './js/3DView/measurements/Measurement.Distance.js';

    let container, stats, camera, scene, renderer, controls;
    container = document.createElement('div');
    document.body.appendChild(container);


    camera = new PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(5, 5, 5);

    // renderer
    renderer = new WebGLRenderer({antialias: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = sRGBEncoding;
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);
    const maxAnisotropy = renderer.capabilities.getMaxAnisotropy();




    //you can use the type of controls you want TrackballControls,OrbitControls...
    const control = new OrbitControls(camera, renderer.domElement);
    control.enableDamping = true;
    control.dampingFactor = 0.25;
    control.enableZoom = true;
    control.minPolarAngle = 0; // radians
    control.maxPolarAngle = Math.PI; 
    control.minAzimuthAngle = -Infinity; // radians
    control.maxAzimuthAngle = Infinity;

    var view = new View3D(document.getElementById( 'container' ), renderer, control,camera);


    const loader = new GLTFLoader();

    const loaderElement = document.getElementById('loader');
    const loadingManager = new THREE.LoadingManager(
    // onLoad callback
    () => {
        loaderElement.style.display = 'none'; // Hide the loader
    },
    // onProgress callback
    (url, itemsLoaded, itemsTotal) => {
        loaderElement.textContent = `Loading ${itemsLoaded} of ${itemsTotal} files...`;
    }
    );
    const gltfLoader = new GLTFLoader(loadingManager);

    loader.load(
	// resource URL
	'./models/mesh.gltf',
	// called when the resource is loaded
	function ( gltf ) {
        
		view.scene.add( gltf.scene );
        gltf.scene.scale.set(.01*gltf.scene.scale.x, .01*gltf.scene.scale.y, .01 * gltf.scene.scale.z)
         // Calculate the bounding box of the model
        const box = new THREE.Box3().setFromObject(gltf.scene);
        const size = box.getSize(new THREE.Vector3()).length();
        const center = box.getCenter(new THREE.Vector3());

        // Adjust camera
        camera.lookAt(center);
        camera.position.copy(center);
        camera.position.x += size / 2.0; // Adjust as needed
        camera.position.y += size / 2.0; // Adjust as needed
        camera.position.z += size / 2.0; // Adjust as needed
        camera.updateProjectionMatrix();

        // Ensure model faces front
        gltf.scene.rotation.y = Math.PI;
        gltf.scene.rotation.x = Math.PI;

        // Set the target of the OrbitControls to the center of the bounding box
        controls.target.copy(center);

        // Make sure to update the controls after changing the target
        controls.update();
        // gltf.scene.rotation.z = Math.PI; // Rotate 180 degrees around Y-axis
        // gltf.scene.scale.set(.01*gltf.scene.scale.x, .01*gltf.scene.scale.y, .01 * gltf.scene.scale.z)
        // gltf.scene.rotation.x = Math.PI * 1.1;
        // gltf.scene.rotation.y = Math.PI * 0.6;
        // // gltf.scene.rotation.z = Math.PI * -0.2;
        // // gltf.scene.position.y = 1.2
        // // gltf.scene.position.z = 1

        // gltf.scene.traverse((node) => {
        //     if (node.isMesh) {
        //         node.geometry.computeVertexNormals();
        //         // node.material = new THREE.MeshPhongMaterial({ color: 0xffffff, map: node.material.map });
        //         if (node.material.map) {
        //             node.material.map.anisotropy = maxAnisotropy;
        //         }
        //     }
        // });
	},
	// called while loading is progressing
	function ( xhr ) {

		console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );

	},
	// called when loading has errors
	function ( error ) {

		console.log( error );

	}
    );

    // Create an ambient light
    const ambientLight = new THREE.AmbientLight(0xffffff, 0);
    view.scene.add(ambientLight);

    // Create a directional light
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.3);
    directionalLight.position.set(0, 1, 0);
    // view.scene.add(directionalLight);

    const hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x000000, 0.6);
    // view.scene.add(hemisphereLight);

    var element=document.getElementById("clearbutton");
    var listener=element.addEventListener('click',function(event){
        view.clearMeasurements();
    });

    var element=document.getElementById("distancebutton");
    var listener=element.addEventListener('click',function(event){
        view.addMeasurement(new MeasurementDistance());
    });

    //on measurement added
    view.addEventListener( 'measurementAdded', function (event) {
        var measurement = event.object;
        if (measurement) {
            var infoDiv = document.getElementById( 'info' );
            var measurementDiv = document.createElement('div');
            measurementDiv.id = 'measurement_' + measurement.id;
            measurementDiv.className = 'measurement_info';
            infoDiv.appendChild(measurementDiv);

            var descriptionDiv = document.createElement('div');
            descriptionDiv.id = 'description_' + measurement.id;
            descriptionDiv.className = 'measurement_description';
            descriptionDiv.innerHTML = measurement.getType() + " = " + (measurement.getValue() * 100).toFixed(1) + " " + JSON.stringify(measurement.getInfo());
            measurementDiv.appendChild(descriptionDiv);

            var removeButton = document.createElement('button');
            removeButton.className = 'measurement_remove';
            removeButton.innerHTML = 'Remove';
            removeButton.onclick = function() {
                view.removeMeasurement(measurement);
            }
            measurementDiv.appendChild(removeButton);
        }
    } );

    //on measurement changed
    view.addEventListener( 'measurementChanged', function (event) {
        var measurement = event.object;
        if (measurement) {
            var descriptionDiv = document.getElementById('description_' + measurement.id);
            if (descriptionDiv)
                descriptionDiv.innerHTML = measurement.getType() + " = " + (measurement.getValue() * 100).toFixed(1);
        }

    } );

    //on measurement removed
    view.addEventListener( 'measurementRemoved', function (event) {
        var measurement = event.object;
        if (measurement) {
            var measurementDiv = document.getElementById('measurement_' + measurement.id);
            measurementDiv.parentNode.removeChild(measurementDiv);
        }

    } );

    function addShadowedLight(x, y, z, color, intensity) {
        const directionalLight = new THREE.DirectionalLight(color, intensity);
        directionalLight.position.set(x, y, z);
        view.scene.add(directionalLight);
        directionalLight.castShadow = true;
        const d = 1;
        directionalLight.shadow.camera.left = -d;
        directionalLight.shadow.camera.right = d;
        directionalLight.shadow.camera.top = d;
        directionalLight.shadow.camera.bottom = -d;
        directionalLight.shadow.camera.near = 1;
        directionalLight.shadow.camera.far = 4;
        directionalLight.shadow.bias = -0.002;
    }

    function showVideoPopup() {
        document.getElementById('videoPopup').style.display = 'block';
        }

    function closeVideoPopup() {
        document.getElementById('videoPopup').style.display = 'none';
        }
    
    document.addEventListener('DOMContentLoaded', function() {
        var videoPreviewMenuItem = document.getElementById("VideoPreview");
        videoPreviewMenuItem.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default behavior of the link
            showVideoPopup(); // Call the function to show the video popup
        });
        var closeVideoButton = document.querySelector('#videoPopup .close');
        closeVideoButton.addEventListener('click', function() {
            closeVideoPopup(); // Call the function to close the video popup
        });
        });

    document.addEventListener('DOMContentLoaded', function() {
        var doctorInputMenuItem = document.getElementById("DoctorInput");
        doctorInputMenuItem.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default behavior of the link
            showDoctorInputPopup(); // Call the function to show the doctor input popup
        });

        var closeDoctorInputButton = document.querySelector('.close-button');
        closeDoctorInputButton.addEventListener('click', function() {
            closeDoctorInputPopup(); // Call the function to close the doctor input popup
        });
        });
        document.getElementById('doctorInputPopup').style.display = 'none';

    function showDoctorInputPopup() {
    document.getElementById('doctorInputPopup').style.display = 'block';
    }

    function closeDoctorInputPopup() {
    document.getElementById('doctorInputPopup').style.display = 'none';
    }

    // // Get the popup element
    // var popup = document.getElementById('doctorInputPopup');

    // // Get the popup's title bar (you can replace 'popupTitle' with the actual ID or class of the title bar)
    // var popupTitle = document.getElementById('doctorInputPopup');

    // // Initialize the position variables
    // var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    // // Function to handle mouse drag events
    // popupTitle.onmousedown = dragMouseDown;

    // // Function to handle mouse drag events
    // function dragMouseDown(e) {
    // e = e || window.event;
    // e.preventDefault();
    // // Get the mouse cursor position at startup
    // pos3 = e.clientX;
    // pos4 = e.clientY;
    // document.onmouseup = closeDragElement;
    // // Call a function whenever the cursor moves
    // document.onmousemove = elementDrag;
    // }

    // // Function to handle the dragging of the popup
    // function elementDrag(e) {
    // e = e || window.event;
    // e.preventDefault();
    // // Calculate the new cursor position
    // pos1 = pos3 - e.clientX;
    // pos2 = pos4 - e.clientY;
    // pos3 = e.clientX;
    // pos4 = e.clientY;
    // // Set the popup's new position
    // popup.style.top = (popup.offsetTop - pos2) + "px";
    // popup.style.left = (popup.offsetLeft - pos1) + "px";
    // }

    // // Function to stop the dragging when the mouse button is released
    // function closeDragElement() {
    // // Stop moving when mouse button is released
    // document.onmouseup = null;
    // document.onmousemove = null;
    // }
    
    // Function to save user input as a text file
    // Function to save user input to GitHub repository
    async function saveToGitHub(name_p, name_s, tip, typ, ssu, sf, sdm, sos, plan, comments)  {
        const fileName = `user_input_${new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')}.txt`;
        const filePath = `comments/${fileName}`; // Specify the path in your repository

        const apiUrl = 'https://api.github.com/repos/IndicVision/Healwell_demo_Nagarajan_2/contents/' + filePath;

        const authToken = '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'; // Replace with your GitHub token

        const content = btoa(`Patient's Name: ${name_p}\nSurgeon's Name: ${name_s}\nTime at Presentation (TIP): ${tip}\nType at Presentation (TYP): ${typ}\nStatus of the Skin/Ulcer (SSU): ${ssu}\nStatus of the Foot (SF): ${sf}\nStatus of Diabetes Mellitus (SDM): ${sdm}\nStatus of the Organ System (SOS): ${sos}\nPlan: ${plan}\nComments: ${comments}`);

        const requestBody = {
            message: `Add ${fileName}`,
            content: content,
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                },
                body: JSON.stringify(requestBody),
            });

            if (response.ok) {
                console.log(`File ${fileName} saved to GitHub repository.`);
            } else {
                console.error('Error saving file to GitHub repository:', response.status, response.statusText);
            }
        } catch (error) {
            console.error('Error saving file:', error.message);
        }
    }

    // Event listener for the Save button
    document.getElementById('saveButton').addEventListener('click', function () {
        // Get user input
        const nameInput_p = document.getElementById('Patient\'s Name');
        const nameInput_s = document.getElementById('Surgeon\'s Name');
        const tipInput = document.getElementById('Time at Presentation (TIP)');
        const typInput = document.getElementById('Type at Presentation (TYP)');
        const ssuInput = document.getElementById('Status of the Skin/Ulcer (SSU)');
        const sfInput = document.getElementById('Status of the Foot (SF)');
        const sdmInput = document.getElementById('Status of Diabetes Mellitus (SDM)');
        const sosInput = document.getElementById('Status of the Organ System (SOS)');
        const planInput = document.getElementById('plan');
        const commentsInput = document.getElementById('comments');

        const name_p = nameInput_p.value;
        const name_s = nameInput_s.value;
        const tip = tipInput.value;
        const typ = typInput.value;
        const ssu = ssuInput.value;
        const sf = sfInput.value;
        const sdm = sdmInput.value;
        const sos = sosInput.value;
        const plan = planInput.value;
        const comments = commentsInput.value;

        // Check if both plan and comments are provided
        if (plan && comments) {
            // Save user input to GitHub repository
            saveToGitHub(name_p, name_s, tip, typ, ssu, sf, sdm, sos, plan, comments);
            // Optionally, clear the input fields after saving
            nameInput_p.value = '';
            nameInput_s.value = '';
            tipInput.value = '';
            typInput.value = '';
            ssuInput.value = '';
            sfInput.value = '';
            sdmInput.value = '';
            sosInput.value = '';
            planInput.value = '';
            commentsInput.value = '';
            // Close the popup
            closeDoctorInputPopup();
        } else {
            alert('Please provide both Plan and Comments before saving.');
        }
    });



</script>

</body>
</html>